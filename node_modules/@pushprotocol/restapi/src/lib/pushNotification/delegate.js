"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Delegate = void 0;
const tslib_1 = require("tslib");
const config_1 = require("../config"), config = config_1;
const PUSH_CHANNEL = require("../channels");
const helpers_1 = require("../helpers");
const pushNotificationBase_1 = require("./pushNotificationBase");
class Delegate extends pushNotificationBase_1.PushNotificationBaseClass {
    constructor(signer, env, account) {
        super(signer, env, account);
        /**
         * @description - Get delegates of a channell
         * @param {string} [options.channel] - channel in caip. defaults to account from signer with eth caip
         * @returns array of delegates
         */
        this.get = (options) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const { channel = this.account
                    ? (0, helpers_1.getFallbackETHCAIPAddress)(this.env, this.account)
                    : null, } = options || {};
                this.checkUserAddressExists(channel);
                if (!(0, helpers_1.validateCAIP)(channel)) {
                    throw new Error('Invalid CAIP');
                }
                return yield PUSH_CHANNEL.getDelegates({
                    channel: channel,
                    env: this.env,
                });
            }
            catch (error) {
                throw new Error(`Push SDK Error: API : delegate::get : ${error}`);
            }
        });
        /**
         * @description adds a delegate
         * @param {string} delegate - delegate address in caip to be added
         * @returns the transaction hash if the transaction is successfull
         */
        this.add = (delegate) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                if (!(0, helpers_1.validateCAIP)(delegate)) {
                    throw new Error('Invalid CAIP');
                }
                const networkDetails = yield this.getChianId(this.signer);
                if (networkDetails !== parseInt(delegate.split(':')[1])) {
                    return new Error('Signer and CAIP chain id doesnt match');
                }
                const caip = `eip155:${networkDetails}`;
                if (!config_1.default[this.env][caip] || !config.VIEM_CONFIG[this.env][caip]) {
                    throw new Error('Unsupported Chainid');
                }
                const commAddress = config_1.default[this.env][caip].EPNS_COMMUNICATOR_CONTRACT;
                const commContract = this.createContractInstance(commAddress, config.ABIS.COMM, config.VIEM_CONFIG[this.env][caip].NETWORK);
                const addDelegateRes = yield this.addDelegator(commContract, delegate.split(':')[2]);
                return { transactionHash: addDelegateRes };
            }
            catch (error) {
                throw new Error(`Push SDK Error: Contract : delegate::add : ${error}`);
            }
        });
        /**
         * @description removes a delegate
         * @param {string} delegate - caip address of the delegate to be removed
         * @returns the transaction hash if the transaction is successfull
         */
        this.remove = (delegate) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                this.checkSignerObjectExists();
                if (this.signer && !this.signer.provider) {
                    throw new Error('Provider is required');
                }
                if (!(0, helpers_1.validateCAIP)(delegate)) {
                    throw new Error('Invalid CAIP');
                }
                const networkDetails = yield this.getChianId(this.signer);
                if (networkDetails !== parseInt(delegate.split(':')[1])) {
                    return new Error('Signer and CAIP chain id doesnt match');
                }
                const caip = `eip155:${networkDetails}`;
                if (!config_1.default[this.env][caip] || !config.VIEM_CONFIG[this.env][caip]) {
                    throw new Error('Unsupported Chainid');
                }
                const commAddress = config_1.default[this.env][caip].EPNS_COMMUNICATOR_CONTRACT;
                const commContract = this.createContractInstance(commAddress, config.ABIS.COMM, config.VIEM_CONFIG[this.env][caip].NETWORK);
                const removeDelegateRes = yield this.removeDelegator(commContract, delegate.split(':')[2]);
                return { transactionHash: removeDelegateRes };
            }
            catch (error) {
                throw new Error(`Push SDK Error: Contract : delegate::remove : ${error}`);
            }
        });
    }
}
exports.Delegate = Delegate;
//# sourceMappingURL=delegate.js.map